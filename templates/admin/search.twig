{% extends "layout/base.twig" %}

{% block title %}Manage Students{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h2>Manage Students</h2>
        <p class="text-muted">View, search, and manage student records</p>
    </div>
    <div>
        <a href="add.php?type=student" class="btn-action btn-primary">
            <i class="bi bi-plus-lg"></i> Add Student
        </a>
    </div>
</div>

<div class="content-card mb-section">
    <div class="card-content">
        <form action="search.php" method="GET" class="search-form-wrapper">
            <div class="input-wrapper">
                <span class="input-icon">
                    <i class="bi bi-search"></i>
                </span>
                <input type="text" name="q" id="search-input" class="form-input input-with-icon" placeholder="Search by name, email, or username..." value="{{ query }}" autocomplete="off">
                <button class="btn-action btn-primary input-addon-btn" type="submit">Search</button>
                {% if query %}
                <a href="search.php" class="btn-action btn-secondary input-addon-btn">Clear</a>
                {% endif %}
            </div>
            <div id="autocomplete-list" class="suggestions-list"></div>
        </form>
    </div>
</div>

<div class="content-card">
    <div class="card-header-bar">
        <span class="card-header-title">Student List</span>
        <span class="badge badge-count">{{ results|length }} On Page</span>
    </div>
    <div class="card-content p-0">
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th class="ps-4">Name</th>
                        <th>Email</th>
                        <th>Username</th>
                        <th>Academic Year</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in results %}
                    <tr>
                        <td class="ps-4">
                            <div class="flex-center justify-start">
                                <div class="user-avatar">
                                    {{ student.first_name|first }}{{ student.last_name|first }}
                                </div>
                                <div>
                                    <div class="fw-bold">{{ student.first_name }} {{ student.last_name }}</div>
                                    <small class="text-muted">{{ student.contact }}</small>
                                </div>
                            </div>
                        </td>
                        <td>{{ student.email }}</td>
                        <td><span class="badge-username">{{ student.username }}</span></td>
                        <td>{{ student.academic_year }}</td>
                        <td class="text-center">
                            <div class="flex-center gap-sm justify-center">
                                <a href="edit.php?id={{ student.id }}" class="btn-action btn-sm btn-outline primary" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <a href="view_attendance.php?id={{ student.id }}" class="btn-action btn-sm btn-outline info" title="Attendance">
                                    <i class="bi bi-calendar-check"></i>
                                </a>
                                {% if session.role == 1 or session.role == 2 %}
                                <a href="delete.php?id={{ student.id }}" class="btn-action btn-sm btn-outline danger" onclick="return confirm('Are you sure you want to delete this student?')" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="empty-state">
                            <i class="bi bi-inbox empty-state-icon"></i>
                            No students found.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    {% if pagination.total > 1 %}
    <div class="card-footer-bar flex-center">
        <!-- Re-implement pagination style if needed, detailed in separate task or simplified here. -->
        <!-- For now, implementing basic logic -->
        <div class="d-flex gap-xs">
             <a href="?q={{ query }}&page={{ pagination.prev_page }}" class="btn-action btn-sm btn-secondary {% if not pagination.has_prev %}disabled btn-disabled{% endif %}">Previous</a>
             
             {% for i in 1..pagination.total %}
             <a href="?q={{ query }}&page={{ i }}" class="btn-action btn-sm {% if pagination.current == i %}btn-primary{% else %}btn-secondary{% endif %}">{{ i }}</a>
             {% endfor %}
             
             <a href="?q={{ query }}&page={{ pagination.next_page }}" class="btn-action btn-sm btn-secondary {% if not pagination.has_next %}disabled btn-disabled{% endif %}">Next</a>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    const searchInput = document.getElementById('search-input');
    const autocompleteList = document.getElementById('autocomplete-list');

    searchInput.addEventListener('input', function() {
        const query = this.value;
        if (query.length < 1) {
            autocompleteList.innerHTML = '';
            return;
        }

        fetch(`search.php?ajax=1&q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                autocompleteList.innerHTML = '';
                if(data.length === 0) {
                     const div = document.createElement('div');
                     div.className = 'suggestion-item text-muted';
                     div.textContent = 'No results found';
                     autocompleteList.appendChild(div);
                     return;
                }
                data.forEach(item => {
                    const a = document.createElement('a');
                    a.href = `search.php?q=${encodeURIComponent(item.text.split(' (')[0])}`; 
                    a.className = 'suggestion-item';
                    // item.text usually contains name + email
                    a.innerHTML = `<i class="bi bi-person me-2"></i> ${item.text}`;
                    autocompleteList.appendChild(a);
                });
            });
    });

    document.addEventListener('click', function(e) {
        if (e.target !== searchInput && e.target !== autocompleteList) {
            autocompleteList.innerHTML = '';
        }
    });
</script>
{% endblock %}
